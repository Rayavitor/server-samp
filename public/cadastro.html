<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/styleCadastro.css" />
    <link rel="icon" type="image/x-icon" href="assets/LogoSimbolo.png" />
    <link
      href="https://fonts.googleapis.com/css?family=Inter"
      rel="stylesheet"
    />
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>SAMP</title>
  </head>

  <body>
    <div class="header">
      <div class="header_logo">
        <a href="index.html">
          <img class="header_img" src="assets/Logo.png" alt="SAMP" />
        </a>
      </div>
      <div class="espaco"></div>
      <div class="header_box"></div>
      <div class="botoes">
        <button class="header_botao">
          <a href="cadastro.html">CADASTRO</a>
        </button>
        <button class="header_botao"><a href="login.html">LOGIN</a></button>
      </div>
    </div>

    <div class="container">
      <div class="cont-esq">
        <img src="assets/VetorDownload.png" />
      </div>
      <div class="cont-dir">
        <div class="container-cadastro">
          <h1>CADASTRE-SE</h1>
          <section id="form_empresa">
            <h3>Cadastro da Empresa:</h3>
            <div class="form">
              <label for="inp_nome_empresa">Nome da Empresa:</label>
              <input id="inp_nome_empresa" />
              <label for="inp_cnpj_empresa">CNPJ:</label>
              <input id="inp_cnpj_empresa" />
              <label for="inp_email_empresa">E-mail:</label>
              <input id="inp_email_empresa" />
            </div>
            <button onclick="navegar()">Avançar</button>
          </section>
          <section id="form_usuario">
            <h3>Cadastro do Usuário:</h3>
            <div class="form">
              <label for="inp_nome_usuario">Nome do Usuário:</label>
              <input id="inp_nome_usuario" />
              <label for="inp_email_usuario">E-mail:</label>
              <input id="inp_email_usuario" />
              <div class="campo-coluna">
                <div class="campo-senha">
                  <label>Senha:</label>
                  <input id="inp_senha_usuario" type="password" />
                </div>
                <div class="campo-senha">
                  <label>Confirme a senha:</label>
                  <input id="inp_conf_senha_usuario" type="password" />
                </div>
              </div>
            </div>
            <div class="campo-coluna">
              <div class="campo-senha">
                <button onclick="navegar()">Voltar</button>
              </div>
              <div class="campo-senha">
                <div id="loading">
                  <img src="assets/loading_verde.gif">
                </div>
                <button id="botaoVisibility" onclick="cadastrar()">Cadastrar</button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </body>
</html>

<script src="js/formCadastro.js"></script>

<script>
  loading.style.display = 'none';

  function mensagem() {
    loading.style.display = 'block';
  }

  function sumir() {
    loading.style.display = 'none';
    botaoVisibility.style.display='block';
  }

  function cadastrar() {
    botaoVisibility.style.display='none';
    loading.style.display = 'flex';
    setInterval(mensagem,4500)
    setInterval(sumir,4500)

    var nomeEmpresa = inp_nome_empresa.value;
    var emailEmpresa = inp_email_empresa.value;
    var cnpj = inp_cnpj_empresa.value;

    var nomeUsuario = inp_nome_usuario.value;
    var emailUsuario = inp_email_usuario.value;
    var senhaUsuario = inp_senha_usuario.value;
    var confirmacaoSenha = inp_conf_senha_usuario.value;

    if (nomeEmpresa == "" && emailEmpresa == "" && cnpj == "") {
      const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Preencha o cadastro da empresa",
      });
      return false
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }else if (nomeEmpresa == "") {
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Informe o nome da empresa",
      });
      return false
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }else if(cnpj == ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Informe o CNPJ",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)

    }
    else if(cnpj.length < 14){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "CNPJ deve ter 14 digitos",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)

    }
     else if (emailEmpresa == "") {
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Preencha o email da empresa",
      });
      return false
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if (emailEmpresa.indexOf("@") == -1) {
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Falta @ no email da empresa",
      });
      return false
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if (emailEmpresa.indexOf(".com")  == -1) {
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Falta .com no email da empresa",
      });
      return false
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if(nomeUsuario == "" && emailUsuario == "" && senhaUsuario ==  "" && confirmacaoSenha == ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Preencha o cadastro do usuário",
      });
      return false
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }else if(nomeUsuario == ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Informe o nome de usuário",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }else if(emailUsuario == ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Informe o email do usuário",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if(emailUsuario.indexOf("@") == -1){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Falta @ no email do usúario",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if(emailUsuario.indexOf(".com") == -1){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Falta .com no email do usúario",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if(senhaUsuario == ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Informe a senha do usuário",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if(senhaUsuario.length < 8){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Informe uma senha com no mínimo 8 digitos",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }
    else if(confirmacaoSenha == ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "Confirme a senha",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }else if (confirmacaoSenha != senhaUsuario) {
        const Toast = Swal.mixin({
        toast: true,
        position: "top",
        showConfirmButton: false,
        timer: 3000,
        
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      Toast.fire({
        icon: "error",
        title: "As senhas não coincidem",
      });
      setInterval(mensagem,4500)
      setInterval(sumir,4500)
    }else{
        setInterval(mensagem,4500)
        setInterval(sumir,4500)
        var validacaoEmailEmpresa = true;
        var validacaoEmailUsuario = true;
        
        fetch(`/usuarios/validarEmailEmpresa/${emailEmpresa}`, {cache: 'no-store'}).then(function (resposta){
            if(resposta.ok){
                if(resposta.status == 200){
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top",
                        showConfirmButton: false,
                        timer: 3000,
                        
                        didOpen: (toast) => {
                          toast.addEventListener("mouseenter", Swal.stopTimer);
                          toast.addEventListener("mouseleave", Swal.resumeTimer);
                        },
                    });
                
                    Toast.fire({
                        icon: "error",
                        title: "Email da empresa já está cadastrado",
                    });

                    validacaoEmailEmpresa = false;
                    setInterval(mensagem,4500)
                    setInterval(sumir,4500)
                }
            }
        });

        fetch(`/usuarios/validarEmailUsuario/${emailUsuario}`, {cache: 'no-store'}).then(function (resposta){
            if(resposta.ok){
                if(resposta.status == 200){
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top",
                        showConfirmButton: false,
                        timer: 3000,
                        
                        didOpen: (toast) => {
                          toast.addEventListener("mouseenter", Swal.stopTimer);
                          toast.addEventListener("mouseleave", Swal.resumeTimer);
                        },
                    });
                
                    Toast.fire({
                        icon: "error",
                        title: "Email do usuário já está cadastrado!",
                    });

                    validacaoEmailUsuario = false;
                }
            }
        }).then(function (){
            if(validacaoEmailEmpresa && validacaoEmailUsuario){
                
                // Enviando o valor da nova input
                fetch("/usuarios/cadastrarEmpresa", {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                    nomeEmpresaServer: nomeEmpresa,
                    emailEmpresaServer: emailEmpresa,
                    cnpjServer: cnpj,
                    }),
                }).then(function (resposta) {
                    console.log("resposta: ", resposta);
    
                    if (resposta.ok) {
                        fetch("/usuarios/selecionarUltimaEmpresa").then(function (resposta) {
                            resposta.json().then(function (json) {
                                console.log(json);
                                console.log(JSON.stringify(json));
    
                                fkEmpresa = json[0].idEmpresa;
    
                                console.log("FOI: " + fkEmpresa);
    
                                fetch("/usuarios/cadastrar", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        nomeServer: nomeUsuario,
                                        emailServer: emailUsuario,
                                        senhaServer: senhaUsuario,
                                        fkEmpresaServer: fkEmpresa,
                                    }),
                                }).then(function (resposta) {
                                    if (resposta.ok) {
                                        window.location = "login.html";
                                    }
                                });
                            });
                        });
                    } else {
                        throw "Houve um erro ao tentar realizar o cadastro!";
                    }
                }).catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
            }
        })

        
                    
    }

    

    return false;
  }
</script>
